<html>
    <head>
        <meta charset="utf-8" />
        <script src="/dst/horn.js"></script>
    </head>
    <body>
        <div>
            <table>
                <tr>
                    <td>昵称</td>
                    <td><input type="text" id="nick" value="王剑冬" /></td>
                </tr>
                <tr>
                    <td>连接方式</td>
                    <td>
                        <select id="conn_type">
                            <option value="websocket">websocket</option>
                            <option value="longpolling">longpolling</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="start">启动连接</button></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="request_chat">请求对话</button></td>
                </tr>
                <tr>
                    <td>用户ID</td>
                    <td><input type="text" id="uid" value="" /></td>
                </tr>
                <tr>
                    <td>对话ID</td>
                    <td><input type="text" id="chat_id" value="chat1" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="join">加入对话</button></td>
                </tr>
                <tr>
                    <td>消息</td>
                    <td><textarea id="msg"></textarea></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="send">发送</button></td>
                </tr>
            </table>
        </div>
        <hr/>

        <div id="content">
        </div>

        <script type="text/javascript">
        $("#start").click(function() {
            var host = "http://app.horn.com:9092/api";
            
            HORN.API.Identity(host, function(uid) {
                start(host, uid);
            }, function(j) {
                console.error(j);
            })
        });

        $("#join").click(function() {
            var chatID = $("#chat_id").val();
            HORN.API.JoinChat(chatID, function(j) {
                console.log(j);
                //j = JSON.parse(j);
                $("#chat_id").val(j.chat_id);
            }, function(j) {
                console.log(j);
            });
        });

        $("#request_chat").click(function() {
            var uid = $("#uid").val();
            HORN.API.RequestChat([uid], function(j) {
                console.log(j);
                //j = JSON.parse(j);
                $("#chat_id").val(j.chat_id);
            }, function(j) {
                console.log(j);
            });
        });
            
        $("#send").click(function() {
            var chatID = $("#chat_id").val(),
                text = $("#msg").val(),
                nick = $("#nick").val(),
                msg = {"type":"text","text": text};
                //msg = JSON.stringify({"msg":text, "nick":nick});
            
            HORN.API.SendMsg(chatID, msg, function(j) {
                console.log(j);
            }, function(j) {
                console.log(j);
            });
        });

        function start(host, uid) {
            var content = $("#content"),
                msg = $("#msg"),
                nick = $("#nick").val(),
                conn_type = $("#conn_type").val();

            HORN.Init({
                uid: uid,
                host: host,
                conn_type: conn_type
            });

            var conn = HORN.GetConnection();

            conn.on("connected", function(json) {
                console.log(json);
                if(json.chats && json.chats.length == 1) {
                    $("#chat_id").val(json.chats[0].ID);
                }
            });

            conn.on("message", function(json) {
                console.log(json);
                if(json.data) {
                    for(var i=0; i<json.data.length; i++) {
                        var m = json.data[i];
                        switch(m.type) {
                            case "text":
                                content.append("<div>"+m.from.name+"说: "+m.text+"</div>");
                            break;
                            case "image":
                                content.append("<div>"+m.from.name+"发送了图片: "+m.image.src+"</div>");
                            break;
                            case "file":
                                content.append("<div>"+m.from.name+"发送了文件: "+m.file.src+"</div>");
                            break;
                            case "request_chat":
                                content.append("<div>"+m.from.name+"请求对话</div>");
                                HORN.API.JoinChat(m.event.chat.id, function(j) {console.log(arguments);$("#chat_id").val(m.event.chat.id);}, function() {console.log(arguments);});
                            break;
                            case "join_chat":
                                content.append("<div>"+m.from.name+"加入了对话 "+m.event.chat.id+"</div>");
                            break;
                        }
                    }
                }
            });

            conn.start();
        }
        </script>
    </body>
</html>