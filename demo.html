<html>
    <head>
        <meta charset="utf-8" />
        <script src="/dst/horn.js"></script>
        <title>demo.html</title>
    </head>
    <body>
        <a href="/demo.html" onclick="location.href=this.href+'?key='+(new Date().getTime());return false;">redirect</a>
        <div>
            <table>
                <tr>
                    <td>昵称</td>
                    <td><input type="text" id="nick" value="王剑冬" /></td>
                </tr>
                <!-- <tr>
                    <td>连接方式</td>
                    <td>
                        <select id="conn_type">
                            <option value="websocket">websocket</option>
                            <option value="longpolling">longpolling</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="start">启动连接</button></td>
                </tr> -->
                <tr>
                    <td></td>
                    <td><button id="request_chat">请求对话</button></td>
                </tr>
                <tr>
                    <td>用户ID</td>
                    <td><input type="text" id="uid" value="" /></td>
                </tr>
                <tr>
                    <td>对话ID</td>
                    <td><input type="text" id="chat_id" value="chat1" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="join">加入对话</button></td>
                </tr>
                <tr>
                    <td>消息</td>
                    <td><textarea id="msg"></textarea></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button id="send">发送</button></td>
                </tr>
            </table>
        </div>
        <hr/>

        <div id="content">
        </div>

        <script type="text/javascript">
        HORN.HOST = "http://app.horn.com:9092/api";
        HORN.CID = "0DWOanOQ9IqkOd3";

        HORN.OnRestore(function(json) {
            console.log(json);
            if(json.chats && json.chats.length == 1) {
                $("#chat_id").val(json.chats[0].ID);
            }
        });

        HORN.OnMessage(function(json) {
            console.log(json);
            if(json.data) {
                for(var i=0; i<json.data.length; i++) {
                    var m = json.data[i];
                    switch(m.type) {
                        case "text":
                            content.append("<div>"+m.from.name+"说: "+m.text+"</div>");
                        break;
                        case "image":
                            content.append("<div>"+m.from.name+"发送了图片: "+m.image.src+"</div>");
                        break;
                        case "file":
                            content.append("<div>"+m.from.name+"发送了文件: "+m.file.src+"</div>");
                        break;
                        case "request_chat":
                            content.append("<div>"+m.from.name+"请求对话</div>");
                            HORN.API.JoinChat(m.event.chat.id, function(j) {console.log(arguments);$("#chat_id").val(m.event.chat.id);}, function() {console.log(arguments);});
                        break;
                        case "join_chat":
                            content.append("<div>"+m.from.name+"加入了对话 "+m.event.chat.id+"</div>");
                        break;
                    }
                }
            }
        });

        HORN.OnError(function(e) {
            console.log("onerror");
        });
        
        HORN.Track(function(res) {
            HORN.Init({
                uid: res.uid,
                track_id: res.track_id,
                fp: res.fp
            });
            HORN.StartHeartbeat(function(r) {
              console.error(r);
            });
        }, function(j) {
            console.error(j);
        });

        $("#join").click(function() {
            var chatID = $("#chat_id").val();
            HORN.JoinChat(chatID, function(j) {
                console.log(j);
                $("#chat_id").val(j.chat_id);
            }, function(j) {
                console.log(j);
            });
        });

        $("#request_chat").click(function() {
            var uid = $("#uid").val();
            HORN.RequestChat([uid], function(j) {
                console.log(j);
                $("#chat_id").val(j.chat_id);
            }, function(j) {
                console.log(j);
            });
        });
            
        $("#send").click(function() {
            var chatID = $("#chat_id").val(),
                text = $("#msg").val(),
                nick = $("#nick").val();
            
            HORN.SendMsgText(chatID, text, function(j) {
                console.log(j);
            }, function(j) {
                console.log(j);
            });
        });
        </script>
    </body>
</html>